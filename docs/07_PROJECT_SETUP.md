# Project Setup Guide & Getting Started

**Version**: 1.0  
**Last Updated**: 2026-02-14  

---

## Overview

This guide walks you through setting up the **AgroMIS** farm management system locally for development.

### Prerequisites

- **macOS** (or Linux/Windows compatible)
- **Node.js** 18.x LTS
- **Postgres** 14+
- **Git**
- **Flutter** SDK 3.x (for mobile)
- **Android Studio** or **Xcode** (for mobile testing)
- **VS Code** (recommended)
- **Postman** or **curl** (for API testing)

---

## Part 1: Backend Setup (NestJS + PostgreSQL)

### Step 1: Clone & Install Backend

```bash
# Navigate to backend directory
cd farm-mis/backend

# Install Node.js dependencies
npm install

# Install NestJS CLI globally (if not already installed)
npm install -g @nestjs/cli
```

### Step 2: PostgreSQL Setup

#### Option A: Using Docker (Recommended)

```bash
# Start PostgreSQL container
docker run --name farm-mis-db \
  -e POSTGRES_USER=farmadmin \
  -e POSTGRES_PASSWORD=SecurePass123! \
  -e POSTGRES_DB=farm_mis_db \
  -p 5432:5432 \
  -d postgres:14

# Verify it's running
docker ps | grep farm-mis-db
```

#### Option B: Local PostgreSQL

```bash
# On macOS
brew install postgresql

# Start PostgreSQL
brew services start postgresql

# Create database and user
createdb farm_mis_db
createuser farmadmin -P  # Set password when prompted
psql farm_mis_db
```

In psql:
```sql
ALTER USER farmadmin CREATEDB;
GRANT ALL PRIVILEGES ON DATABASE farm_mis_db TO farmadmin;
\q
```

### Step 3: Environment Configuration

Create `.env` file in `backend/`:

```env
# Database
DATABASE_URL=postgresql://farmadmin:SecurePass123!@localhost:5432/farm_mis_db
DATABASE_HOST=localhost
DATABASE_PORT=5432
DATABASE_USER=farmadmin
DATABASE_PASSWORD=SecurePass123!
DATABASE_NAME=farm_mis_db

# JWT
JWT_SECRET=your-super-secret-key-min-32-chars-long-for-dev
JWT_EXPIRATION=86400  # 24 hours

# Node Environment
NODE_ENV=development
PORT=3000

# Logging
LOG_LEVEL=debug

# Optional: Sentry (error tracking)
SENTRY_DSN=https://...  # Leave empty for MVP
```

### Step 4: Run Database Migrations

```bash
# Create initial schema
npm run typeorm migration:generate -- -n initial-schema

# Run migrations
npm run start:db

# Or manually with TypeORM CLI
npm run typeorm migration:run
```

### Step 5: Start Backend Server

```bash
# Development mode (with hot reload)
npm run start:dev

# Or production build + start
npm run build
npm run start:prod
```

**Expected output**:
```
[NestFactory] Starting Nest application...
[InstanceLoader] AppModule dependencies initialized
[RoutesResolver] AppController {/api/v1}:
[RouterExplorer] Mapped {/api/v1/auth/login, POST} route
...
Listening on port 3000
```

Visit: **http://localhost:3000/health** â†’ should return `{ "status": "ok" }`

---

## Part 2: Mobile Setup (Flutter)

### Step 1: Install Flutter SDK

```bash
# On macOS, using Homebrew
brew install flutter

# Verify installation
flutter doctor

# Expected output should show:
# - Flutter SDK âœ“
# - Android toolchain (can defer)
# - Xcode âœ“
# - VS Code âœ“
```

### Step 2: Initialize Flutter Project

```bash
cd farm-mis/mobile

# Create new Flutter project (if not already scaffolded)
flutter create .

# Or if project exists
flutter pub get  # Install dependencies
```

### Step 3: Configure Local Database (SQLite + Drift)

Create `lib/database/database.dart`:

```dart
import 'package:drift/drift.dart';
import 'package:drift_flutter/drift_flutter.dart';

// Import generated database code (will be generated by build_runner)
part 'database.g.dart';

@DriftDatabase(tables: [
  Animals,
  Activities,
  FeedItems,
  StockBatches,
  Sales,
  Expenses,
  // ... other tables
])
class AppDatabase extends _$AppDatabase {
  AppDatabase() : super(_openConnection());

  @override
  int get schemaVersion => 1;
}

LazyDatabase _openConnection() {
  return LazyDatabase(() async {
    final dbFolder = await getApplicationDocumentsDirectory();
    final file = File(p.join(dbFolder.path, 'farm_mis_db.sqlite'));
    return openConnection(file);
  });
}
```

### Step 4: Generate Drift ORM Code

```bash
# From mobile directory
cd farm-mis/mobile

# Generate database code
flutter pub run build_runner build --delete-conflicting-outputs

# Watch mode (auto-regenerate on changes)
flutter pub run build_runner watch
```

### Step 5: Configure API Base URL

Create `lib/config/api_config.dart`:

```dart
class ApiConfig {
  static const String baseUrl = 'http://localhost:3000/api/v1';
  // On physical device Android emulator, use: http://10.0.2.2:3000
  // On iOS simulator: http://localhost:3000
}
```

### Step 6: Run Flutter App

#### On Web

```bash
flutter run -d chrome
# Or: flutter run -d chrome --web-renderer canvaskit
```

#### On Android Emulator

```bash
# List available emulators
flutter emulators

# Launch emulator
flutter emulators launch <emulator_name>

# Run app
flutter run
```

#### On iOS Simulator

```bash
# Launch simulator
open -a Simulator

# Run app
flutter run -d macos  # If just testing on macOS first
# Or for iOS
flutter run -d iphone
```

**Expected output**:
```
Launching lib/main.dart on iPhone Pro in debug mode...
âœ… Connected
âœ… App loaded successfully
```

---

## Part 3: Local Development Workflow

### Terminal Setup

Open **3 terminals**:

**Terminal 1: Backend**
```bash
cd farm-mis/backend
npm run start:dev
# Watch for file changes; auto-reload
```

**Terminal 2: Mobile**
```bash
cd farm-mis/mobile
flutter run
# Hot reload with 'r' after changes
```

**Terminal 3: Database/Utilities**
```bash
# Use for:
# - Database migrations
# - Running scripts
# - Checking logs
cd farm-mis/backend
```

### Hot Reload Workflow

**Backend (NestJS)**:
1. Edit `.ts` file
2. Save
3. NestJS auto-detects and restarts relevant module

**Mobile (Flutter)**:
1. Edit `.dart` file
2. Save
3. Type `r` in Flutter terminal
4. App hot-reloads (state preserved)

---

## Part 4: Testing Backend API Locally

### Using Postman

1. **Import OpenAPI spec**:
   - File â†’ Import
   - Paste OpenAPI URL or JSON from `docs/06_API_SPEC.md`
   - Postman auto-generates collection

2. **Set variables**:
   - Click "Environments" â†’ "New"
   - Add: `base_url = http://localhost:3000/api/v1`
   - Save

3. **Test registration**:
   ```
   POST {{base_url}}/auth/register
   {
     "email": "owner@farm.local",
     "password": "TestPass123!",
     "full_name": "Test Owner",
     "farm_name": "Test Farm"
   }
   ```
   - Copy `access_token` from response

4. **Test protected endpoint**:
   ```
   GET {{base_url}}/tenants/me
   Header: Authorization: Bearer <token>
   ```

### Using cURL

```bash
# Register
curl -X POST http://localhost:3000/api/v1/auth/register \
  -H "Content-Type: application/json" \
  -d '{
    "email": "owner@farm.local",
    "password": "TestPass123!",
    "full_name": "Test Owner",
    "farm_name": "Test Farm"
  }'

# Copy token from response, then:
curl -X GET http://localhost:3000/api/v1/tenants/me \
  -H "Authorization: Bearer YOUR_TOKEN_HERE"
```

---

## Part 5: Database Management

### Viewing Database

```bash
# Connect to database
psql farm_mis_db -U farmadmin

# View tables
\dt

# Check schema
\d animals

# View data
SELECT * FROM tenants LIMIT 5;

# Exit
\q
```

### Running Migrations

```bash
cd farm-mis/backend

# Generate new migration from Entity changes
npm run typeorm migration:generate -- -n <migration_name>

# Run pending migrations
npm run typeorm migration:run

# Revert last migration
npm run typeorm migration:revert
```

---

## Part 6: Useful Commands

### Backend

```bash
# Run linting
npm run lint

# Run tests
npm run test

# Run tests in watch mode
npm run test:watch

# Build for production
npm run build

# Check for vulnerabilities
npm audit
```

### Mobile

```bash
# Clean build
flutter clean

# Get fresh dependencies
flutter pub get

# Run tests
flutter test

# Build APK (for Android)
flutter build apk

# Build IPA (for iOS)
flutter build ios
```

---

## Part 7: Debugging

### Backend Debugging in VS Code

Create `.vscode/launch.json`:

```json
{
  "version": "0.2.0",
  "configurations": [
    {
      "type": "node",
      "request": "launch",
      "name": "Launch Backend",
      "program": "${workspaceFolder}/backend/dist/main.js",
      "restart": true,
      "console": "integratedTerminal",
      "skipFiles": ["<node_internals>/**"],
      "env": {
        "NODE_ENV": "development"
      }
    }
  ]
}
```

Then: `F5` to start debugging.

### Mobile Debugging

```bash
# Flutter DevTools (browser-based IDE)
flutter pub global activate devtools
pub global run devtools

# Then in another terminal
flutter run --devtools
```

Or use **VS Code Flutter extension** (recommended):
- Install: "Flutter" by Dart Code
- `F5` to debug
- Set breakpoints

---

## Part 8: Troubleshooting

### PostgreSQL Connection Issues

```bash
# Test connection
psql -h localhost -U farmadmin -d farm_mis_db

# If fails, check if running
docker ps | grep farm-mis-db

# Or on macOS
brew services list | grep postgres
```

### NestJS Port Already In Use

```bash
# Kill process on port 3000
lsof -ti:3000 | xargs kill -9

# Or change port in .env
PORT=3001
```

### Flutter Dependency Issues

```bash
# Clean everything
flutter clean
dart pub cache clean

# Reinstall
flutter pub get
flutter pub run build_runner build --delete-conflicting-outputs
```

### SQLite Database Locked

```bash
# Stop all Flutter processes and restart:
flutter run
```

---

## Part 9: Environment Variables Checklist

### Backend (.env)

- [ ] `DATABASE_URL` â€” PostgreSQL connection string
- [ ] `JWT_SECRET` â€” min 32 characters
- [ ] `NODE_ENV` â€” set to "development"
- [ ] `PORT` â€” default 3000

### Mobile (lib/config/api_config.dart)

- [ ] `baseUrl` â€” backend API URL (localhost:3000 for dev)

---

## Part 10: Verification Checklist

After setup, verify all working:

```bash
# Backend
[ ] npm run start:dev â†’ "Listening on port 3000"
[ ] GET http://localhost:3000/health â†’ { "status": "ok" }
[ ] POST /auth/register â†’ token issued
[ ] GET /tenants/me (with token) â†’ tenant details

# Mobile
[ ] flutter run â†’ App loads on simulator/device
[ ] App connects to backend â†’ "Synced" indicator
[ ] Can login with test account
[ ] Activity recorded offline â†’ shows in queue

# Database
[ ] psql connects â†’ tables visible via \dt
[ ] tenants table has 1 row
[ ] users table has 1 row
```

---

## Docker Compose Setup (Optional, For Full Stack)

Create `docker-compose.yml` in root:

```yaml
version: '3.8'

services:
  db:
    image: postgres:14
    environment:
      POSTGRES_USER: farmadmin
      POSTGRES_PASSWORD: SecurePass123!
      POSTGRES_DB: farm_mis_db
    ports:
      - "5432:5432"
    volumes:
      - postgres_data:/var/lib/postgresql/data

  backend:
    build:
      context: ./backend
      dockerfile: Dockerfile
    environment:
      DATABASE_URL: postgresql://farmadmin:SecurePass123!@db:5432/farm_mis_db
      JWT_SECRET: dev-secret-key-min-32-chars
      NODE_ENV: development
    ports:
      - "3000:3000"
    depends_on:
      - db
    volumes:
      - ./backend:/app/backend
    command: npm run start:dev

volumes:
  postgres_data:
```

Then:
```bash
docker-compose up -d
# Backend runs at http://localhost:3000
# Database at localhost:5432
```

---

## CI/CD Setup (GitHub Actions)

Create `.github/workflows/ci.yml`:

```yaml
name: CI/CD

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]

jobs:
  backend:
    runs-on: ubuntu-latest
    services:
      postgres:
        image: postgres:14
        env:
          POSTGRES_PASSWORD: postgres
        options: >-
          --health-cmd pg_isready
          --health-interval 10s

    steps:
      - uses: actions/checkout@v2
      - uses: actions/setup-node@v2
        with:
          node-version: 18
      - run: cd backend && npm install
      - run: npm run lint
      - run: npm run test
      - run: npm run build
```

---

## Next Steps

Now that you have everything configured:

1. âœ… **Read documentation**
   - Review `docs/01_PRD.md` and `docs/02_DATA_MODEL.md`
   - Understand data flow in `docs/04_SYNC_STRATEGY.md`

2. âœ… **Create first features**
   - Start with Week 1â€“3 milestones from `docs/05_MILESTONES.md`
   - Begin backend modules: auth, tenants, animals

3. âœ… **Test locally**
   - Use Postman to verify API
   - Test mobile login flow

4. âœ… **Push to repo**
   - Commit setup files
   - Create GitHub branches for each milestone

---

## Support & Debugging

If stuck:

1. Check **logs**: Look at terminal output for errors
2. Check **database**: View tables and data via psql
3. Check **network**: Ensure backend is listening on port 3000
4. Check **permissions**: Ensure you have write access to directories
5. Check **dependencies**: Run `npm audit` and `flutter pub outdated`

---

## Conclusion

You now have a complete local development environment ready. Next: start building! ðŸš€

See `docs/05_MILESTONES.md` for your first week's tasks.

